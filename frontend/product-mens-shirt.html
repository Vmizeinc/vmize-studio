<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classic Oxford Shirt - Vmize Studio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --vmize-purple: #6B4CE6;
            --vmize-blue: #4CC9F0;
            --text-primary: #1a1a1a;
            --text-secondary: #666;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-primary);
            background: #fafafa;
        }

        /* Header */
        header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 16px 32px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo img {
            height: 50px;
        }

        nav {
            display: flex;
            gap: 32px;
            align-items: center;
        }

        nav a {
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 600;
            transition: color 0.3s;
        }

        nav a:hover {
            color: var(--vmize-purple);
        }

        .btn-dashboard {
            padding: 10px 24px;
            background: linear-gradient(135deg, var(--vmize-purple), var(--vmize-blue));
            color: white !important;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
        }

        .back-btn {
            padding: 10px 20px;
            background: white;
            color: var(--vmize-purple);
            border: 2px solid var(--vmize-purple);
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            border: none;
        }

        .back-btn:hover {
            background: #f5f3ff;
            transform: translateX(-4px);
        }

        /* Product Page */
        .product-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 32px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 60px;
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .product-image-section {
            position: relative;
        }

        .product-main-image {
            width: 100%;
            aspect-ratio: 2/3;
            border-radius: 12px;
            overflow: hidden;
            background: #f0f0f0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .product-main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .badge {
            position: absolute;
            top: 16px;
            left: 16px;
            background: black;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 700;
        }

        /* Product Info */
        .product-info {
            display: flex;
            flex-direction: column;
        }

        .brand {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .product-name {
            font-size: 16px;
            color: #555;
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .rating {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 20px;
        }

        .stars {
            color: #ffa500;
            font-size: 16px;
        }

        .price-section {
            margin-bottom: 24px;
        }

        .current-price {
            font-size: 32px;
            font-weight: 700;
            color: #c41e3a;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn {
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-add-bag {
            background: #c41e3a;
            color: white;
        }

        .btn-tryon {
            background: linear-gradient(135deg, var(--vmize-purple), var(--vmize-blue));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-tryon:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(107, 76, 230, 0.3);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: #999;
        }

        .upload-section {
            border: 3px dashed #ddd;
            border-radius: 12px;
            padding: 48px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 24px;
        }

        .upload-section:hover {
            border-color: var(--vmize-purple);
            background: #f5f3ff;
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .loading {
            text-align: center;
            padding: 48px;
            display: none;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--vmize-purple);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-section {
            display: none;
        }

        .result-section.active {
            display: block;
        }

        .result-image {
            width: 100%;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        /* Footer */
        footer {
            background: white;
            padding: 48px 32px;
            margin-top: 80px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }

        .footer-content {
            max-width: 1400px;
            margin: 0 auto;
        }

        .footer-grid {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 48px;
            margin-bottom: 40px;
        }

        .footer-logo img {
            height: 50px;
            margin-bottom: 16px;
        }

        .footer-desc {
            color: var(--text-secondary);
            line-height: 1.6;
            max-width: 300px;
        }

        .footer-links h4 {
            margin-bottom: 16px;
            font-weight: 700;
        }

        .footer-links a {
            display: block;
            color: var(--text-secondary);
            text-decoration: none;
            margin-bottom: 12px;
            transition: color 0.3s;
        }

        .footer-links a:hover {
            color: var(--vmize-purple);
        }

        .footer-bottom {
            border-top: 1px solid #e0e0e0;
            padding-top: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .footer-bottom p {
            color: #999;
            font-size: 14px;
        }

        @media (max-width: 900px) {
            .product-grid {
                grid-template-columns: 1fr;
            }
            nav {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-content">
            <a href="index.html" class="logo">
                                <span id="logoImg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 512 512">
                                        <image href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAIAAAB7GkOtAAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABA... (base64 continues) ..." width="40" height="40"/>
                                    </svg>
                                </span>
            </a>
            <nav>
                <a href="index.html">Home</a>
                <a href="about.html">About</a>
                <a href="demo-public.html">Demo</a>
                <a href="integration.html">Integration</a>
                <a href="login.html" class="btn-dashboard">Dashboard</a>
            </nav>
            <button class="back-btn" onclick="goBack()">
                <span>‚Üê</span> Back
            </button>
        </div>
    </header>

    <!-- Product Container -->
    <div class="product-container">
        <div class="product-grid">
            <!-- Product Image (Full Length) -->
            <div class="product-image-section">
                <div class="product-main-image">
                    <img src="https://images.unsplash.com/photo-1620012253295-c15cc3e65df4?w=600&h=900&fit=crop&q=80" alt="Classic Oxford Shirt" id="productImage">
                </div>
                <div class="badge">NEW</div>
            </div>

            <!-- Product Info -->
            <div class="product-info">
                <div class="brand">Premium Menswear</div>
                <div class="product-name">Classic Oxford Shirt - Premium cotton blend, tailored fit</div>
                
                <div class="rating">
                    <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</span>
                    <span class="review-count">4.3 (213 reviews)</span>
                </div>

                <div class="price-section">
                    <span class="current-price">$79.99</span>
                    <span class="discount">(50% off)</span>
                    <span class="original-price">$159.98</span>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button class="btn btn-add-bag">Add To Bag</button>
                    <button class="btn btn-tryon" onclick="openTryOnModal()">
                        <span>üëó</span>
                        <span>Virtual Try-On</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Try-On Modal -->
    <div class="modal" id="tryonModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Virtual Try-On</div>
                <button class="close-btn" onclick="closeTryOnModal()">√ó</button>
            </div>

            <div class="upload-section" id="uploadSection" onclick="document.getElementById('photoUpload').click()">
                <div class="upload-icon">üì∏</div>
                <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">Upload Your Photo</div>
                <div style="font-size: 14px; color: #666;">Click to upload or drag and drop</div>
                <input type="file" id="photoUpload" accept="image/*" onchange="handleUpload(event)" style="display: none;">
            </div>

            <div class="loading" id="loadingSection" style="display: none;">
                <div class="spinner"></div>
                <p style="color: #666;">Processing your try-on... This may take 10-30 seconds</p>
            </div>

            <div class="result-section" id="resultSection">
                <img src="" alt="Try-on result" class="result-image" id="resultImage">
                <button class="btn btn-add-bag" style="width: 100%;">Add To Bag</button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer>
        <div class="footer-content">
            <div class="footer-grid">
                <div>
                    <div class="footer-logo">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 512 512">
                                                    <image href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAgAAAAIACAIAAAB7GkOtAAAAAXNSR0IArs4c6QAAAERlWElmTU0AKgAAAAgAAYdpAAQAAAABA... (base64 continues) ..." width="40" height="40"/>
                                                </svg>
                    </div>
                    <p class="footer-desc">
                        AI-powered virtual try-on technology that helps e-commerce brands increase conversion and reduce returns.
                    </p>
                </div>
                <div class="footer-links">
                    <h4>Product</h4>
                    <a href="demo-public.html">Demo</a>
                    <a href="integration.html">Integration</a>
                    <a href="dashboard-complete.html">Dashboard</a>
                </div>
                <div class="footer-links">
                    <h4>Company</h4>
                    <a href="about.html">About</a>
                    <a href="#">Careers</a>
                    <a href="#">Contact</a>
                </div>
                <div class="footer-links">
                    <h4>Support</h4>
                    <a href="#">Help Center</a>
                    <a href="#">Documentation</a>
                    <a href="#">API Reference</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>¬© 2025 Vmize Studio. All rights reserved. Based in San Jose, California.</p>
                <div class="footer-legal">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Load logo
        fetch('/mnt/user-data/uploads/ChatGPT_Image_Dec_26__2025__08_25_13_PM.png')
            .then(response => response.blob())
            .then(blob => {
                const url = URL.createObjectURL(blob);
                document.getElementById('logoImg').src = url;
                document.querySelector('.footer-logo-img').src = url;
            })
            .catch(() => console.log('Logo loading failed'));

        // Smart back button - tracks user's navigation history
        function goBack() {
            // Get session history
            const sessionHistory = JSON.parse(sessionStorage.getItem('vmize_nav_history') || '[]');
            
            if (sessionHistory.length > 1) {
                // Remove current page
                sessionHistory.pop();
                // Get previous page
                const previousPage = sessionHistory[sessionHistory.length - 1];
                sessionStorage.setItem('vmize_nav_history', JSON.stringify(sessionHistory));
                window.location.href = previousPage;
            } else if (document.referrer && document.referrer.indexOf(window.location.host) !== -1) {
                window.history.back();
            } else {
                window.location.href = 'demo-public.html';
            }
        }

        // Track navigation
        window.addEventListener('load', () => {
            const sessionHistory = JSON.parse(sessionStorage.getItem('vmize_nav_history') || '[]');
            sessionHistory.push(window.location.pathname);
            // Keep only last 10 pages
            if (sessionHistory.length > 10) sessionHistory.shift();
            sessionStorage.setItem('vmize_nav_history', JSON.stringify(sessionHistory));
        });

        // Try-On Modal Functions
        function openTryOnModal() {
            document.getElementById('tryonModal').classList.add('active');
            // Track event
            trackEvent('try_on_initiated', {
                product: 'mens-shirt',
                product_name: 'Classic Oxford Shirt',
                price: 79.99
            });
        }

        function closeTryOnModal() {
            document.getElementById('tryonModal').classList.remove('active');
            // Reset modal
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('resultSection').classList.remove('active');
        }

        async function handleUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Track upload event
            trackEvent('photo_uploaded', {
                product: 'mens-shirt',
                file_size: file.size
            });

            // Show loading
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('loadingSection').style.display = 'block';

            // Get product image URL
            const garmentImageUrl = document.getElementById('productImage').src;
            
            // Convert uploaded file to base64
            const modelImageBase64 = await fileToBase64(file);

            try {
                // Call Fashn API through backend proxy (hidden from frontend)
                const result = await callFashnAPI(modelImageBase64, garmentImageUrl);

                // Show result
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('resultSection').classList.add('active');
                document.getElementById('resultImage').src = result.output_url || result.raw?.output?.image_url || '';

                // Track success
                trackEvent('result_generated', {
                    product: 'mens-shirt',
                    success: true
                });

            } catch (error) {
                console.error('Try-on failed:', error);
                document.getElementById('loadingSection').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'block';
                alert('Try-on failed. Please try again.');

                // Track error
                trackEvent('result_generated', {
                    product: 'mens-shirt',
                    success: false,
                    error: error.message
                });
            }
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Call Fashn API through backend proxy (HIDDEN FROM FRONTEND)
        // Now uses start->poll flow and a demo key header for demo pages
        async function callFashnAPI(modelImageBase64, garmentImageUrl) {
            const DEMO_KEY = 'vmize_pk_demo_test_1234567890';

            // Start
            const startResp = await fetch('/api/v1/tryon', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${DEMO_KEY}`,
                    'x-vmize-api-key': DEMO_KEY
                },
                body: JSON.stringify({
                    model_image: `data:image/png;base64,${modelImageBase64}`,
                    garment_image: garmentImageUrl,
                    category: 'tops'
                })
            });

            if (!startResp.ok) {
                const err = await startResp.json().catch(() => ({}));
                throw new Error(err.error || 'API request failed');
            }

            const startData = await startResp.json();
            const id = startData.prediction_id || startData.id || startData.predictionId;
            if (!id) throw new Error('No prediction id returned');

            // Poll for result (timeout 30s)
            const timeout = 30000;
            const interval = 1500;
            const deadline = Date.now() + timeout;

            while (Date.now() < deadline) {
                await new Promise(r => setTimeout(r, interval));

                const statusResp = await fetch(`/api/v1/tryon/${id}`, {
                    headers: { 'Authorization': `Bearer ${DEMO_KEY}`, 'x-vmize-api-key': DEMO_KEY }
                });

                if (!statusResp.ok) {
                    const err = await statusResp.json().catch(() => ({}));
                    throw new Error(err.error || 'Status check failed');
                }

                const statusData = await statusResp.json();
                if (statusData.status === 'completed' || statusData.status === 'succeeded') {
                    const outputUrl = statusData.output?.image_url || statusData.output_url || statusData.result?.image_url;
                    return { output_url: outputUrl, raw: statusData };
                }
            }

            throw new Error('Timeout waiting for try-on result');
        }

        // Track events to analytics
        function trackEvent(eventName, properties) {
            // Send to backend for analytics
            fetch('/api/analytics/track', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    event: eventName,
                    properties: properties,
                    timestamp: new Date().toISOString(),
                    session_id: getSessionId(),
                    user_ip: null // Backend will add this
                })
            }).catch(err => console.log('Analytics tracking failed:', err));

            // Also store locally for demo
            const events = JSON.parse(localStorage.getItem('vmize_events') || '[]');
            events.push({
                event: eventName,
                properties: properties,
                timestamp: new Date().toISOString()
            });
            // Keep only last 100 events
            if (events.length > 100) events.shift();
            localStorage.setItem('vmize_events', JSON.stringify(events));
        }

        // Get or create session ID
        function getSessionId() {
            let sessionId = sessionStorage.getItem('vmize_session_id');
            if (!sessionId) {
                sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('vmize_session_id', sessionId);
            }
            return sessionId;
        }

        // Track page view
        trackEvent('page_view', {
            page: 'product-mens-shirt',
            product: 'Classic Oxford Shirt'
        });
    </script>
</body>
</html>
