name: Build and Push Backend Docker Image (GHCR)

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write

jobs:
  build-push:
    runs-on: ubuntu-latest
    env:
      IMAGE: ghcr.io/${{ github.repository_owner }}/vmize-backend:${{ github.sha }}
      IMAGE_LATEST: ghcr.io/${{ github.repository_owner }}/vmize-backend:latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build and push image
        uses: docker/build-push-action@v4
        with:
          context: vmize/backend
          push: true
          tags: |
            ${{ env.IMAGE }}
            ${{ env.IMAGE_LATEST }}


      - name: Optional: SSH to server to pull image and restart
        if: ${{ secrets.DEPLOY_VIA_SSH == 'true' }}
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || '22' }}
          script: |
            IMAGE=${IMAGE}
            echo "Pulling image $IMAGE"
            docker pull $IMAGE
            docker stop vmize-backend || true
            docker rm vmize-backend || true
            docker run -d --restart unless-stopped --name vmize-backend -p 5000:5000 \
              --env-file /home/${{ secrets.VPS_USER }}/vmize-backend/.env.production \
              $IMAGE

            # Post-deploy health check (fail if unhealthy)
            HEALTH_URL=${{ secrets.DEPLOY_HEALTH_URL || 'http://127.0.0.1:5000/health' }}
            echo "Checking health endpoint: $HEALTH_URL"
            RETRIES=10
            SLEEP=5
            i=0
            until [ $i -ge $RETRIES ]
            do
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
              echo "Attempt $((i+1)) - status=$STATUS"
              if [ "$STATUS" = "200" ]; then
                echo "Health check passed"
                exit 0
              fi
              i=$((i+1))
              sleep $SLEEP
            done
            echo "Health check failed after $RETRIES attempts"
            exit 1
